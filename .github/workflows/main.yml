name: Generate mihomo 

on:
  repository_dispatch:
    types: [trigger-from-sb-rule-sets]
  workflow_dispatch:
  
permissions:
  contents: write

jobs:
  generate_lists:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Pull Changes
        run: git pull

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y curl wget git jq
         
      - name: Download and install Mihomo
        run: |
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://github.com/MetaCubeX/mihomo/releases/download/v1.19.9/mihomo-linux-amd64-v1.19.9.deb -o mihomo-linux-amd64-v1.19.9.deb
          sudo apt install --fix-missing ./mihomo-linux-amd64-v1.19.9.deb
        
      - name: Generate ru-bundle
        env:
          NO_SKIP: true
        run: |
         mkdir -p ru-bundle
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://github.com/legiz-ru/sb-rule-sets/raw/main/ru-bundle.lst -o ru-bundle.lst
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://github.com/itdoginfo/allow-domains/raw/main/Russia/inside-raw.lst -o itdoginfo-inside-russia.lst
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://community.antifilter.download/list/domains.lst -o antifilter-community.lst
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://github.com/legiz-ru/sb-rule-sets/raw/main/no-russia-hosts.json -o no-russia-hosts.json
         jq -r '.rules[].domain_suffix[]' no-russia-hosts.json > no-russia-hosts.lst
         echo "payload:" > rule.yaml && cat ru-bundle.lst | sed "s/.*/- '+.&'/" >> rule.yaml
         mihomo convert-ruleset domain yaml rule.yaml rule.mrs
         sed 's/^/+\./' ru-bundle.lst > rule.list
         echo "payload:" > itdoginfo-inside-russia.yaml && cat itdoginfo-inside-russia.lst | sed "s/.*/- '+.&'/" >> itdoginfo-inside-russia.yaml
         mihomo convert-ruleset domain yaml itdoginfo-inside-russia.yaml itdoginfo-inside-russia.mrs
         echo "payload:" > antifilter-community.yaml && cat antifilter-community.lst | sed "s/.*/- '+.&'/" >> antifilter-community.yaml
         mihomo convert-ruleset domain yaml antifilter-community.yaml antifilter-community.mrs
         echo "payload:" > no-russia-hosts.yaml && cat no-russia-hosts.lst | sed "s/.*/- '+.&'/" >> no-russia-hosts.yaml
         mihomo convert-ruleset domain yaml no-russia-hosts.yaml no-russia-hosts.mrs
         mv rule.yaml rule.mrs rule.list itdoginfo-inside-russia.yaml itdoginfo-inside-russia.mrs antifilter-community.yaml antifilter-community.mrs no-russia-hosts.yaml no-russia-hosts.mrs ru-bundle/
      - name: Generate RKN ASN Blocklist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p ru-bundle
          
          # Список ASN из статьи
          cat <<EOF > asn_numbers.txt
          12876 174 14061 14544 16276 16509 16625 20054 20473 20860 21130 21859 24940 27458 
          29447 31898 32149 32810 9009 8849 1219 6142 51167 51765 53667 55170 56630 58061 
          60068 62240 62563 63023 63593 63949 151151 153366 138915 141995 202422 209058 
          209265 209312 209703 209753 209765 209920 211812 211829 211865 212238 212317 
          213230 213900 214041 214206 215939 272575 274113 274115 274118 274119 274117 
          274116 393511 393515 393929 394093 396051 42708 42831 36352 13335 11775 34 3292 
          1680 2860 13692 13727 13693 14237 14627 14670 15083 15224 15626 15897 16391 1267 
          16802 17054 17426 17452 18229 18747 18779 18978 19224 19624 19969 20326 20853 
          20915 20940 21581 21785 22652 22890 23028 23471 23352 23693 24994 25697 25829 
          26068 27284 26832 27257 28323 29838 29873 29863 30320 12400 30938 31727 32132 
          32181 32552 32489 32613 33028 33198 33333 33442 33905 979 9829 9924 984 9498 906 
          9246 8943 9294 9299 36323 917 8987 9121 8796 9260 9002 9186 37552 9457 7713 38008 
          7303 852 12217 8551 8100 8708 4618 6220 6057 4657 4761 12083 4804 5089 44521 44932 
          45758 46185 46188 46261 46484 46632 46979 48678 49791 50520 50881 51577 51791 
          51847 51964 53107 53356 54600 55688 55701 55836 55960 56106 58854 59134 59538 
          59943 60064 60117 60602 60800 61112 61866 61429 64123 63981 64249 132139 11572 
          198967 199699 199829 199524 134286 134303 134351 135069 135600 135629 136491 
          136744 150436 151338 151690 151704 152565 152672 153531 153952 153997 136897 
          136988 137816 138754 138997 139646 139659 139989 140457 140227 140443 141312 
          146943 149042 200435 200325 200547 200736 200904 201217 201924 201814 201838 
          201971 202042 202412 202673 202662 202675 11432 203268 203380 203833 204731 
          205759 205771 206947 206934 207567 207695 208636 208621 209049 209087 209153 
          209170 209240 209326 209360 209372 209479 209492 209529 209535 209561 209589 
          209591 209630 209784 209835 209980 209992 210743 210869 210893 211358 210874 
          211808 211826 212636 212637 213035 213122 213873 213790 213881 215691 215762 
          215826 216221 263237 263807 263693 263812 263834 265484 266444 264617 267212 
          266602 269070 268581 272611 271761 328073 328867 393925 43653 43376 395668 
          42649 396037 396868 396860 396990 43160 41378 399377 41480 400211 399804 
          401486 401560 400897 10099 10361 1100 10929 34927 34970 35251 35699 35758 
          35916 36183 36666 399122 399275 399647 40021 40029 400810 40934 37517 38001 
          393398 393457 39351 394256 394869 395354 395717 396026 396073 396998 397032 
          397162 397373 397377 398343 398465 398478 398721 398823
          EOF

          # Скачивание с использованием авторизации
          touch raw_ips.txt
          for asn in $(cat asn_numbers.txt); do
            curl -sL -H "Authorization: token $GH_TOKEN" "https://github.com/MetaCubeX/meta-rules-dat/raw/meta/asn/AS${asn}.list" >> raw_ips.txt || echo "Skip AS${asn}"
          done

          # Агрегация (схлопывание) IP адресов через Python
          python3 -c "
          import ipaddress
          networks = []
          with open('raw_ips.txt', 'r') as f:
              for line in f:
                  line = line.strip()
                  if not line or line.startswith('#'): continue
                  try:
                      networks.append(ipaddress.ip_network(line))
                  except ValueError: continue
          
          merged = ipaddress.collapse_addresses(networks)
          with open('ru-bundle/rknasnblock.list', 'w') as out:
              for net in merged:
                  out.write(str(net) + '\n')
          "
          
          # Конвертация в binary ruleset (.mrs)
          mihomo convert-ruleset ipcidr text ru-bundle/rknasnblock.list ru-bundle/rknasnblock.mrs
          
          # Очистка временных файлов
          rm raw_ips.txt asn_numbers.txt

      - name: Generate re-filter
        env:
          NO_SKIP: true
        run: |
         mkdir -p re-filter
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://github.com/1andrevich/Re-filter-lists/raw/main/ipsum.lst -o re-filter-ip.text
         mihomo convert-ruleset ipcidr text re-filter-ip.text ip-rule.mrs
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://github.com/1andrevich/Re-filter-lists/raw/main/domains_all.lst -o re-filter-domain.text
         echo "payload:" > domain-rule.yaml && cat re-filter-domain.text | sed "s/.*/- '+.&'/" >> domain-rule.yaml
         mihomo convert-ruleset domain yaml domain-rule.yaml domain-rule.mrs
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://github.com/Akiyamov/singbox-ech-list/releases/latest/download/domains_noech.lst -o re-filter-noech.lst
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://github.com/Akiyamov/singbox-ech-list/releases/latest/download/domains_ech.lst -o re-filter-ech.lst
         echo "payload:" > re-filter-noech.yaml && cat re-filter-noech.lst | sed "s/.*/- '+.&'/" >> re-filter-noech.yaml
         mihomo convert-ruleset domain yaml re-filter-noech.yaml re-filter-noech.mrs
         echo "payload:" > re-filter-ech.yaml && cat re-filter-ech.lst | sed "s/.*/- '+.&'/" >> re-filter-ech.yaml
         mihomo convert-ruleset domain yaml re-filter-ech.yaml re-filter-ech.mrs
         mv domain-rule.yaml domain-rule.mrs ip-rule.mrs re-filter-ech.yaml re-filter-ech.mrs re-filter-noech.yaml re-filter-noech.mrs re-filter/
      - name: Generate oisd
        env:
          NO_SKIP: true
        run: |
         mkdir -p oisd
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://github.com/sjhgvr/oisd/raw/main/domainswild2_big.txt -o oisd_big.txt
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://github.com/sjhgvr/oisd/raw/main/domainswild2_nsfw.txt -o oisd_nsfw.txt
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://github.com/sjhgvr/oisd/raw/main/domainswild2_nsfw_small.txt -o oisd_nsfw_small.txt
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://github.com/sjhgvr/oisd/raw/main/domainswild2_small.txt -o oisd_small.txt
         grep -v '^\s*$' oisd_big.txt | grep -v '^#' > tmp && mv tmp oisd_big.txt
         grep -v '^\s*$' oisd_nsfw.txt | grep -v '^#' > tmp && mv tmp oisd_nsfw.txt
         grep -v '^\s*$' oisd_nsfw_small.txt | grep -v '^#' > tmp && mv tmp oisd_nsfw_small.txt
         grep -v '^\s*$' oisd_small.txt | grep -v '^#' > tmp && mv tmp oisd_small.txt
         echo "payload:" > big.yaml && cat oisd_big.txt | sed "s/.*/- '+.&'/" >> big.yaml
         echo "payload:" > nsfw.yaml && cat oisd_nsfw.txt | sed "s/.*/- '+.&'/" >> nsfw.yaml
         echo "payload:" > nsfw_small.yaml && cat oisd_nsfw_small.txt | sed "s/.*/- '+.&'/" >> nsfw_small.yaml
         echo "payload:" > small.yaml && cat oisd_small.txt | sed "s/.*/- '+.&'/" >> small.yaml
         mihomo convert-ruleset domain yaml big.yaml big.mrs
         mihomo convert-ruleset domain yaml nsfw.yaml nsfw.mrs
         mihomo convert-ruleset domain yaml nsfw_small.yaml nsfw_small.mrs
         mihomo convert-ruleset domain yaml small.yaml small.mrs
         mv big.yaml big.mrs nsfw.yaml nsfw.mrs nsfw_small.yaml nsfw_small.mrs small.yaml small.mrs oisd/
      - name: Generate other rulesets
        env:
          NO_SKIP: true
        run: |
         mkdir -p other
         curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://raw.githubusercontent.com/legiz-ru/sb-rule-sets/refs/heads/main/ru-app-list.json | jq -r '.rules[].rules[].package_name[]' | sed 's/^/ - PROCESS-NAME,/' | sed '1i payload:' > other/ru-app-list.yaml
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://github.com/GhostRooter0953/discord-voice-ips/raw/master/voice_domains/discord-voice-ip-list -o discord-voice-ip-list.text
         sed -i 's/$/\/32/' discord-voice-ip-list.text
         mihomo convert-ruleset ipcidr text discord-voice-ip-list.text discord-voice-ip-list.mrs
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://raw.githubusercontent.com/sakib-m/Pi-hole-Torrent-Blocklist/main/all-torrent-websites.txt -o torrent-websites.txt
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://raw.githubusercontent.com/sakib-m/Pi-hole-Torrent-Blocklist/main/all-torrent-trackers.txt -o torrent-trackers.txt
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://github.com/legiz-ru/sb-rule-sets/raw/main/torrent-clients.json -o torrent-clients.json
         mihomo convert-ruleset domain text torrent-websites.txt torrent-websites.mrs
         mihomo convert-ruleset domain text torrent-trackers.txt torrent-trackers.mrs
         echo "payload:" > torrent-clients.yaml && \
         jq -r '.rules[] | .rules[] | select(.process_name != null) | .process_name[] | "  - PROCESS-NAME," + .' torrent-clients.json >> torrent-clients.yaml && \
         jq -r '.rules[] | .rules[] | select(.package_name != null) | .package_name[] | "  - PROCESS-NAME," + .' torrent-clients.json >> torrent-clients.yaml
         mv torrent-websites.mrs torrent-trackers.mrs torrent-clients.yaml discord-voice-ip-list.mrs other/
      - name: Generate v2ray templates for vpnbot
        env:
          NO_SKIP: true
        run: |
         mkdir -p other
         curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -L https://github.com/mercurykd/vpnbot/raw/dev/config/v2ray.json -o other/vpnbot-v2ray-ru-bundle.json
         domains=$(cat ru-bundle.lst | jq -R . | jq -s .) && jq --argjson domains "$domains" '(.routing.rules | to_entries | .[] | select(.value.outboundTag == "block").key + 1) as $idx | .routing.rules = .routing.rules[0:$idx] + [{"type": "field", "outboundTag": "~outbound~", "domain": $domains}] + .routing.rules[$idx:]' other/vpnbot-v2ray-ru-bundle.json > temp.json && mv temp.json other/vpnbot-v2ray-ru-bundle.json
         jq '.routing.rules as $rules | ($rules | to_entries | map(select(.value.outboundTag == "block" and .value.domain == "~block~")) | .[0].key + 1) as $idx | .routing.rules = $rules[0:$idx] + [{"type": "field", "outboundTag": "block", "domain": ["geosite:category-ads-all"]}] + $rules[$idx:]' other/vpnbot-v2ray-ru-bundle.json > other/vpnbot-v2ray-ru-bundle-category-ads-all.json
      - name: Generate v2ray templates for marzban
        env:
          NO_SKIP: true
        run: |
         cp .github/workflows/v2ray-marzban-base.json other/marzban-v2ray-ru-bundle-category-ads-all.json
         domains=$(jq -R -s 'split("\n") | map(select(length > 0))' ru-bundle.lst) && jq --argjson added "$domains" '(.dns.servers[1].domains |= (if type=="string" then [.] else . end)) | (.dns.servers[1].domains += $added) | (.routing.rules |= map(if .domain then .domain |= (if type=="string" then [.] else . end) else . end)) | (.routing.rules |= map(if (.domain == ["domain:cloudflare-ech.com", "domain:cloudflare-dns.com", "domain:one.one.one.one"]) then .domain += $added else . end))' other/marzban-v2ray-ru-bundle-category-ads-all.json > temp.json && mv temp.json other/marzban-v2ray-ru-bundle-category-ads-all.json
         cp .github/workflows/v2ray-marzban-base-ios.json other/marzban-v2ray-ru-bundle.json
         domains=$(jq -R -s 'split("\n") | map(select(length > 0))' ru-bundle.lst) && jq --argjson added "$domains" '(.dns.servers[1].domains |= (if type=="string" then [.] else . end)) | (.dns.servers[1].domains += $added) | (.routing.rules |= map(if .domain then .domain |= (if type=="string" then [.] else . end) else . end)) | (.routing.rules |= map(if (.domain == ["domain:cloudflare-ech.com", "domain:cloudflare-dns.com", "domain:one.one.one.one"]) then .domain += $added else . end))' other/marzban-v2ray-ru-bundle.json > temp.json && mv temp.json other/marzban-v2ray-ru-bundle.json
      - name: Delete temp file
        run: |
          rm ru-bundle.lst | rm re-filter-ip.text | rm re-filter-domain.text |  rm re-filter-ech.lst | rm re-filter-noech.lst
          rm itdoginfo-inside-russia.lst | rm antifilter-community.lst | rm no-russia-hosts.json | rm no-russia-hosts.lst
          rm oisd_big.txt | rm oisd_nsfw.txt | rm oisd_nsfw_small.txt | rm oisd_small.txt | rm discord-voice-ip-list.text
          rm torrent-websites.txt | rm torrent-trackers.txt | rm torrent-clients.json | rm mihomo-linux-amd64-v1.19.9.deb
          
      - name: Get current date
        id: date
        run: |
          echo "DATE=$(TZ=Europe/Moscow date +'%Y-%m-%dT%H:%M:%S')" >> $GITHUB_ENV
      
      - name: Commit and Push Changes
        run: |
          git config --local user.email "legiz-ru@users.noreply.github.com"
          git config --local user.name "legiz-ru"
          git add .
          git commit -m "Generating .mrs rule-sets ${{ env.DATE }}" -a || echo "No changes to commit"
          git push
